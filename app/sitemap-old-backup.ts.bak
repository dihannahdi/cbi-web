/**
 * Dynamic Sitemap Generator with i18n Support
 * Generates comprehensive XML sitemap with all pages, products, news, and blogs
 * Follows Google's sitemap protocol and best practices for multilingual sites
 */

import { MetadataRoute } from 'next';
import { i18n } from '@/i18n-config';

const BASE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://www.centrabiotechindonesia.com';
const API_URL = process.env.NEXT_PUBLIC_URL_API || 'https://cbi-backend.my.id';

// Supported locales from i18n config
const locales = i18n.locales;
const defaultLocale = i18n.defaultLocale;

interface StrapiResponse<T> {
  data: T[];
  meta?: {
    pagination?: {
      total: number;
    };
  };
}

interface DynamicItem {
  id: number;
  slug?: string;
  documentId?: string;
  updatedAt?: string;
  publishedAt?: string;
  createdAt?: string;
  title?: string;
  name?: string;
  image?: {
    url?: string;
    alternativeText?: string;
  };
}

/**
 * Fetch dynamic content from Strapi API with error handling
 */
async function fetchFromStrapi<T>(endpoint: string): Promise<T[]> {
  try {
    const response = await fetch(`${API_URL}/api/${endpoint}?populate=image&pagination[pageSize]=100`, {
      next: { revalidate: 3600 }, // Cache for 1 hour
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      console.warn(`Sitemap: Failed to fetch ${endpoint}, status: ${response.status}`);
      return [];
    }

    const json: StrapiResponse<T> = await response.json();
    return json.data || [];
  } catch (error) {
    console.warn(`Sitemap: Error fetching ${endpoint}:`, error);
    return [];
  }
}

/**
 * Fetch all dynamic routes from CMS
 */
async function fetchDynamicRoutes() {
  const [products, news, blogs, maklonArticles] = await Promise.all([
    fetchFromStrapi<DynamicItem>('products'),
    fetchFromStrapi<DynamicItem>('newses'), // Strapi pluralizes as 'newses'
    fetchFromStrapi<DynamicItem>('blogs'),
    fetchFromStrapi<DynamicItem>('maklon-articles'),
  ]);

  return { products, news, blogs, maklonArticles };
}

/**
 * Get the most recent date from item
 */
function getLastModified(item: DynamicItem): Date {
  const date = item.updatedAt || item.publishedAt || item.createdAt;
  return date ? new Date(date) : new Date();
}

/**
 * Generate alternates for each locale with proper language codes
 * Following Google's hreflang guidelines and next-intl best practices
 */
function generateAlternates(path: string): Record<string, string> {
  const alternates: Record<string, string> = {};
  
  // Map locales to proper language codes for hreflang
  const languageCodes: Record<string, string> = {
    'id': 'id-ID', // Indonesian
    'en': 'en-US', // English
  };
  
  locales.forEach((locale) => {
    // Use proper language code for SEO
    const langCode = languageCodes[locale] || locale;
    alternates[langCode] = `${BASE_URL}/${locale}${path}`;
  });
  
  // Add x-default pointing to default locale (best practice for multilingual sites)
  alternates['x-default'] = `${BASE_URL}/${defaultLocale}${path}`;
  
  return alternates;
}

/**
 * Create sitemap entries for all locales
 */
function createMultilingualEntries(
  path: string, 
  lastModified: Date, 
  changeFrequency: 'always' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'yearly' | 'never',
  priority: number
): MetadataRoute.Sitemap {
  return locales.map((locale) => ({
    url: `${BASE_URL}/${locale}${path}`,
    lastModified,
    changeFrequency,
    priority,
    alternates: {
      languages: generateAlternates(path),
    },
  }));
}

/**
 * Main sitemap generator with i18n support
 */
export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const { products, news, blogs, maklonArticles } = await fetchDynamicRoutes();
  const currentDate = new Date();

  // ============================================
  // STATIC ROUTES (Multilingual)
  // ============================================
  const staticRoutes: MetadataRoute.Sitemap = [
    // Homepage - highest priority
    ...createMultilingualEntries('', currentDate, 'daily', 1.0),
    // About page
    ...createMultilingualEntries('/about-us', currentDate, 'monthly', 0.8),
    // Contact page
    ...createMultilingualEntries('/contact', currentDate, 'monthly', 0.7),
    // News listing
    ...createMultilingualEntries('/news', currentDate, 'daily', 0.8),
    // Blog listing
    ...createMultilingualEntries('/blog', currentDate, 'daily', 0.8),
    // Maklon Pupuk listing
    ...createMultilingualEntries('/maklon-pupuk', currentDate, 'weekly', 0.8),
    // Career page
    ...createMultilingualEntries('/career', currentDate, 'weekly', 0.6),
    // Documents page
    ...createMultilingualEntries('/documents', currentDate, 'monthly', 0.5),
    // Product category pages - high priority
    ...createMultilingualEntries('/product/agriculture', currentDate, 'weekly', 0.9),
    ...createMultilingualEntries('/product/livestock', currentDate, 'weekly', 0.9),
    ...createMultilingualEntries('/product/fishery', currentDate, 'weekly', 0.9),
  ];

  // ============================================
  // DYNAMIC PRODUCT ROUTES (Multilingual)
  // Only include products with valid slugs (not random documentIds)
  // ============================================
  const productRoutes: MetadataRoute.Sitemap = products
    .filter((product) => {
      // Only include products with proper slugs (not random documentIds)
      const slug = product.slug;
      return slug && typeof slug === 'string' && slug.length > 0 && !slug.match(/^[a-z0-9]{20,}$/i);
    })
    .flatMap((product) => {
      const slug = product.slug!;
      const path = `/product/${slug}`;
      
      return locales.map((locale) => ({
        url: `${BASE_URL}/${locale}${path}`,
        lastModified: getLastModified(product),
        changeFrequency: 'weekly' as const,
        priority: 0.7,
        alternates: {
          languages: generateAlternates(path),
        },
      }));
    });

  // ============================================
  // DYNAMIC NEWS ROUTES (Multilingual)
  // ============================================
  const newsRoutes: MetadataRoute.Sitemap = news.flatMap((item) => {
    const slug = item.slug || item.documentId || String(item.id);
    const path = `/news/${slug}`;
    
    return locales.map((locale) => ({
      url: `${BASE_URL}/${locale}${path}`,
      lastModified: getLastModified(item),
      changeFrequency: 'weekly' as const,
      priority: 0.6,
      alternates: {
        languages: generateAlternates(path),
      },
    }));
  });

  // ============================================
  // DYNAMIC BLOG ROUTES (Multilingual)
  // ============================================
  const blogRoutes: MetadataRoute.Sitemap = blogs.flatMap((item) => {
    const slug = item.slug || item.documentId || String(item.id);
    const path = `/blog/${slug}`;
    
    return locales.map((locale) => ({
      url: `${BASE_URL}/${locale}${path}`,
      lastModified: getLastModified(item),
      changeFrequency: 'weekly' as const,
      priority: 0.6,
      alternates: {
        languages: generateAlternates(path),
      },
    }));
  });

  // ============================================
  // DYNAMIC MAKLON PUPUK ROUTES (Multilingual)
  // ============================================
  const maklonRoutes: MetadataRoute.Sitemap = maklonArticles.flatMap((item) => {
    const slug = item.slug || item.documentId || String(item.id);
    const path = `/maklon-pupuk/${slug}`;
    
    return locales.map((locale) => ({
      url: `${BASE_URL}/${locale}${path}`,
      lastModified: getLastModified(item),
      changeFrequency: 'weekly' as const,
      priority: 0.6,
      alternates: {
        languages: generateAlternates(path),
      },
    }));
  });

  // Combine all routes
  return [
    ...staticRoutes,
    ...productRoutes,
    ...newsRoutes,
    ...blogRoutes,
    ...maklonRoutes,
  ];
}
